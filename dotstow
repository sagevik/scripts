#!/bin/sh

# Shell script to select and stow dotfile folders using fzf

# Define the dotfiles directory (adjust this to your dotfiles path)
DOTFILES_DIR="$HOME/dev/dots"

# Define color codes
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
CYAN="\033[1;36m"
NC="\033[0m"

# Function to display a colored message with borders
msg() {
    msg=" $1 "
    color_var="${2:-GREEN}"
    color=$(eval echo "\$$color_var")

    border=$(echo "$msg" | sed 's/./-/g')
    echo -e "$CYAN$border"
    echo -e "$color$msg"
    echo -e "$CYAN$border$NC"
}

# Check if DOTFILES_DIR exists
if [ ! -d "$DOTFILES_DIR" ]; then
    echo -e "${RED}Error: Dotfiles directory '$DOTFILES_DIR' does not exist.${NC}"
    exit 1
fi

# List all folders in DOTFILES_DIR, excluding README.md
list_folders() {
    ls -d "$DOTFILES_DIR"/*/ | grep -v "README.md" | while read -r folder; do
        basename "$folder"
    done
}

# Main script
msg "Dotfiles Stow Manager"

# Get the list of folders and pass to fzf for multi-selection
selected_folders=$(list_folders | fzf --multi --prompt="> " --header="Select folders to stow (up/dn/tab to (de)select)" --layout=reverse --border=rounded)

# Check if any folders were selected
if [ -z "$selected_folders" ]; then
    echo -e "${YELLOW}No folders selected. Exiting.${NC}"
    exit 0
fi

# Stow each selected folder
for folder in $selected_folders; do
    echo -e "${CYAN}Stowing $folder...${NC}"
    if stow -R -d "$DOTFILES_DIR" -t "$HOME" "$folder"; then
        echo -e "Folder $folder -> ${GREEN}stowed successfully${NC}"
    else
        echo -e "Folder $folder -> ${RED}failed to stow${NC}"
    fi
done

msg "Stowing complete" "GREEN"
